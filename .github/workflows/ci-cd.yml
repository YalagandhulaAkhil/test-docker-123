name: CI-CD â€” Phase 1 (ECR) & Phase 2 (ECS EC2)

on:
  push:
    branches: [ main ]          # run on every push to main
  workflow_dispatch:            # allow manual run

permissions:
  id-token: write
  contents:  read

env:
  AWS_REGION:       ${{ secrets.AWS_REGION }}
  STACK_NAME_ECR:   ${{ secrets.STACK_NAME_ECR }}      # e.g. phase1-ecr-stack
  STACK_NAME_ECS:   ${{ secrets.STACK_NAME_ECS }}      # e.g. phase2-ecs-stack
  REPO_NAME:        ${{ secrets.REPO_NAME }}           # e.g. my-html-site

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region:     ${{ env.AWS_REGION }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸªª Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ³ Build & Push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG:    latest
      run: |
        docker build -t $ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG .
        docker push  $ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG
        echo "IMAGE_URI=$ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG" >> $GITHUB_ENV

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸš€ Deploy Phase 1 â€“ ECR stack
      run: |
        aws cloudformation deploy \
          --template-file infra/phase1-ecr.yml \
          --stack-name   "$STACK_NAME_ECR" \
          --capabilities CAPABILITY_NAMED_IAM \
          --parameter-overrides RepoName=$REPO_NAME

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸš€ Deploy Phase 2 â€“ ECS EC2 stack
      run: |
        aws cloudformation deploy \
          --template-file infra/phase2-ecs.yml \
          --stack-name   "$STACK_NAME_ECS" \
          --capabilities CAPABILITY_NAMED_IAM \
          --parameter-overrides ImageUrl=$IMAGE_URI
