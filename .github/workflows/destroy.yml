name: Destroy Phase-1 (ECR repo + stack)

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "ECR repository name (leave blank to use secrets.ECR_REPO)"
        required: false
        default: ""

permissions:
  id-token: write
  contents:  read

env:
  AWS_REGION:   ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
  STACK_NAME:   phase1-ecr-stack
  REPO_NAME:    ${{ github.event.inputs.repo_name != '' && github.event.inputs.repo_name || secrets.ECR_REPO }}

jobs:
  nuke:
    runs-on: ubuntu-latest

    steps:
      # ── Assume the OIDC role ───────────────────────────────────────
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region:     ${{ env.AWS_REGION }}

      # ── Delete the Phase-1 stack, retry if DELETE_FAILED ───────────
      - name: Delete Phase-1 stack (plus ECR cleanup if needed)
        run: |
          set -e
          echo "🗑️  Deleting CloudFormation stack $STACK_NAME ..."
          aws cloudformation delete-stack --stack-name "$STACK_NAME"

          # First wait attempt
          if aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME"; then
            echo "✅ Stack deleted successfully."
            exit 0
          fi

          echo "⚠️  Stack stuck in DELETE_FAILED. Force-deleting ECR repo $REPO_NAME ..."
          aws ecr delete-repository --repository-name "$REPO_NAME" --force || true

          echo "🔄 Retrying stack deletion ..."
          aws cloudformation delete-stack --stack-name "$STACK_NAME"
          aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME"

          echo "✅ Phase-1 stack and ECR repo fully removed."
