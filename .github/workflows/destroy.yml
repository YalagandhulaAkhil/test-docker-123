name: Destroy ECR and ECS Resources

on:
  workflow_dispatch:
    inputs:
      phase1_stack:
        description: 'Stack name for Phase 1 (ECR)'
        required: true
        default: 'phase1-ecr-stack'
      phase2_stack:
        description: 'Stack name for Phase 2 (ECS)'
        required: true
        default: 'phase2-ecs-stack'

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clean up ECR images
        run: |
          echo "üßº Checking and deleting images from ECR repo..."
          REPO_NAME=${{ secrets.ECR_REPO }}
          IMAGES=$(aws ecr list-images --repository-name "$REPO_NAME" --query 'imageIds[*]' --output json)
          if [[ "$IMAGES" != "[]" ]]; then
            echo "$IMAGES" | jq -c '.[]' | while read image; do
              aws ecr batch-delete-image --repository-name "$REPO_NAME" --image-ids "$image"
            done
            echo "‚úÖ Images deleted from $REPO_NAME."
          else
            echo "‚ÑπÔ∏è No images to delete."
          fi

      - name: Delete Phase 2 ECS stack
        run: |
          echo "üóëÔ∏è  Deleting ECS stack ${{ github.event.inputs.phase2_stack }} ..."
          aws cloudformation delete-stack --stack-name ${{ github.event.inputs.phase2_stack }}
          aws cloudformation wait stack-delete-complete --stack-name ${{ github.event.inputs.phase2_stack }}
          echo "‚úÖ ECS stack deleted."

      - name: Delete Phase 1 ECR stack
        run: |
          echo "üóëÔ∏è  Deleting ECR stack ${{ github.event.inputs.phase1_stack }} ..."
          aws cloudformation delete-stack --stack-name ${{ github.event.inputs.phase1_stack }}
          aws cloudformation wait stack-delete-complete --stack-name ${{ github.event.inputs.phase1_stack }}
          echo "‚úÖ ECR stack deleted."