name: Destroy ECS EC2 Stack

on:
  workflow_dispatch:
    inputs:
      stack_to_delete:
        description: CloudFormation stack name
        required: false        # ← optional
        default: ""            # ← leave blank so we can fall back to secret

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION:  ${{ secrets.AWS_REGION }}
      # Use the UI input if provided, otherwise fall back to the secret
      STACK_NAME:  ${{ github.event.inputs.stack_to_delete != '' && github.event.inputs.stack_to_delete || secrets.STACK_NAME }}
      ECR_REPO:    ${{ secrets.ECR_REPO }}

    steps:
      # ── Assume role via OIDC ───────────────────────────────────
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region:     ${{ env.AWS_REGION }}

      # ── Delete CloudFormation stack ───────────────────────────
      - name: Delete CloudFormation stack
        run: |
          echo "Deleting stack $STACK_NAME ..."
          aws cloudformation delete-stack --stack-name "$STACK_NAME"
          echo "Waiting until it’s gone ..."
          aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME"
          echo "✅ CloudFormation stack deleted."

      # ── Optional: delete ECR repo (to avoid storage charges) ──
      - name: Delete ECR repository (if empty)
        run: |
          echo "Attempting to delete ECR repo $ECR_REPO ..."
          aws ecr delete-repository --repository-name "$ECR_REPO" --force || true
          echo "Done."
