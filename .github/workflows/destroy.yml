name: Destroy Phase-1 (ECR repo)

on:
  workflow_dispatch:         # run it manually from the Actions tab
    inputs:
      repo_name:
        description: "ECR repository to delete (default = secret ECR_REPO)"
        required: false
        default: ""

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION:   ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
  STACK_NAME:   phase1-ecr-stack
  REPO_NAME:    ${{ github.event.inputs.repo_name != '' && github.event.inputs.repo_name || secrets.ECR_REPO }}

jobs:
  nuke:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region:     ${{ env.AWS_REGION }}

      - name: Delete CloudFormation stack
        run: |
          echo "üóëÔ∏è  Deleting CFN stack ${STACK_NAME} ‚Ä¶"
          aws cloudformation delete-stack --stack-name "${STACK_NAME}"
          aws cloudformation wait stack-delete-complete --stack-name "${STACK_NAME}"
          echo "‚úÖ Stack deleted."

      - name: Delete ECR repository
        run: |
          echo "üóëÔ∏è  Deleting ECR repo ${REPO_NAME} (if it exists) ‚Ä¶"
          aws ecr delete-repository --repository-name "${REPO_NAME}" --force || \
            echo "Repository not found; nothing to delete."
          echo "‚úÖ Done."
