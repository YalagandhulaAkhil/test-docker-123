name: Destroy Phase 1 & Phase 2 Stacks

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents:  read

env:
  AWS_REGION:       ${{ secrets.AWS_REGION }}
  STACK_NAME_ECR:   ${{ secrets.STACK_NAME_ECR }}
  STACK_NAME_ECS:   ${{ secrets.STACK_NAME_ECS }}
  REPO_NAME:        ${{ secrets.REPO_NAME }}

jobs:
  destroy:
    runs-on: ubuntu-latest

    steps:
    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐ Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region:     ${{ env.AWS_REGION }}

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐งน Empty ECR repository images
      run: |
        echo "Listing images in $REPO_NAME โฆ"
        IDS=$(aws ecr list-images --repository-name "$REPO_NAME" --query 'imageIds' --output json 2>/dev/null || echo "[]")
        if [[ "$IDS" != "[]" ]]; then
          aws ecr batch-delete-image --repository-name "$REPO_NAME" --image-ids "$IDS"
          echo "Images deleted."
        else
          echo "Repo already empty or not found."
        fi

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐๏ธ Delete ECS stack
      run: |
        aws cloudformation delete-stack --stack-name "$STACK_NAME_ECS"
        aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME_ECS" || true

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐๏ธ Delete ECR stack
      run: |
        aws cloudformation delete-stack --stack-name "$STACK_NAME_ECR"
        aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME_ECR" || true

    # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    - name: ๐๏ธ Delete ECR repository
      run: |
        aws ecr delete-repository --repository-name "$REPO_NAME" --force || true
