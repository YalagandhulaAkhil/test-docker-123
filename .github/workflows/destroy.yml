name: Destroy Phase-1 + Phase-2 stacks & ECR repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "ECR repo to delete (blank â†’ secrets.ECR_REPO)"
        required: false
        default: ""

permissions:
  id-token: write
  contents:  read

env:
  AWS_REGION:   ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
  ECR_STACK:    phase1-ecr-stack
  ECS_STACK:    phase2-ecs-cluster
  REPO_NAME:    ${{ github.event.inputs.repo_name != '' && github.event.inputs.repo_name || secrets.ECR_REPO }}

jobs:
  nuke:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.AWS_ROLE_ARN }}
        aws-region:     ${{ env.AWS_REGION }}

    # â”€â”€ empty & delete ECR repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Empty and delete ECR repo
      run: |
        set -e
        echo "ðŸ”Ž Listing images in $REPO_NAME â€¦"
        IMAGES=$(aws ecr list-images --repository-name "$REPO_NAME" --query 'imageIds' --output json 2>/dev/null || echo "[]")
        if [ "$IMAGES" != "[]" ]; then
          echo "ðŸ—‘  Deleting images â€¦"
          aws ecr batch-delete-image --repository-name "$REPO_NAME" --image-ids "$IMAGES" || true
        fi
        echo "ðŸ—‘  Deleting repository â€¦"
        aws ecr delete-repository --repository-name "$REPO_NAME" --force || true

    # â”€â”€ delete stacks (ECS first, then ECR) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete Phase-2 ECS stack
      run: |
        aws cloudformation delete-stack --stack-name "$ECS_STACK"
        aws cloudformation wait stack-delete-complete --stack-name "$ECS_STACK" || true

    - name: Delete Phase-1 ECR stack
      run: |
        aws cloudformation delete-stack --stack-name "$ECR_STACK"
        aws cloudformation wait stack-delete-complete --stack-name "$ECR_STACK" || true

    - name: âœ… Finished
      run: echo "All Phase-1 & Phase-2 resources removed."
