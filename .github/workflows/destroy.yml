name: Destroy All Stacks

on:
  workflow_dispatch:
    inputs:
      stack_ecr:
        description: "ECR Stack Name"
        required: true
        default: "phase1-ecr-stack"
      stack_ecs:
        description: "ECS Stack Name"
        required: true
        default: "phase2-ecs-stack"
      repo_name:
        description: "ECR Repo Name"
        required: true
        default: "my-html-site"

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

    steps:
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete all images in ECR Repo
        run: |
          set +e
          aws ecr list-images --repository-name ${{ github.event.inputs.repo_name }} --query 'imageIds[*]' --output json > images.json
          if [[ $(jq length images.json) -gt 0 ]]; then
            aws ecr batch-delete-image \
              --repository-name ${{ github.event.inputs.repo_name }} \
              --image-ids "$(cat images.json)"
          fi

      - name: Delete ECS Stack
        run: |
          echo "ğŸ—‘ï¸ Deleting ECS Stack: ${{ github.event.inputs.stack_ecs }}"
          aws cloudformation delete-stack --stack-name "${{ github.event.inputs.stack_ecs }}"
          aws cloudformation wait stack-delete-complete --stack-name "${{ github.event.inputs.stack_ecs }}"
          echo "âœ… ECS Stack deleted."

      - name: Delete ECR Stack
        run: |
          echo "ğŸ—‘ï¸ Deleting ECR Stack: ${{ github.event.inputs.stack_ecr }}"
          aws cloudformation delete-stack --stack-name "${{ github.event.inputs.stack_ecr }}"
          aws cloudformation wait stack-delete-complete --stack-name "${{ github.event.inputs.stack_ecr }}"
          echo "âœ… ECR Stack deleted."

      - name: Delete ECR Repo (optional)
        run: |
          aws ecr delete-repository --repository-name "${{ github.event.inputs.repo_name }}" --force || true
